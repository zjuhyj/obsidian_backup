- **Seasonal-Trend decomposition procedure （STL）**基于局部加权回归平滑器（LOESS）将一个序列分解为趋势、季节性和剩余成分。但是<u>这种平滑处理阻碍了对时间序列内部变化的检测</u>。

---
## 0 个人思考

- 在STL中以更新后的趋势项作为内循环间的联系，而计算趋势项是通过对去趋势数据进行LOESS平滑和低通滤波获得季节成分，再减去季节成分获得

## 1 局部加权回归平滑器（LOESS）

参考：
- [数据处理_局部回归平滑_局部加权回归散点平滑法-CSDN博客](https://blog.csdn.net/kinkinhe/article/details/136605334) K是核函数，写错了

- 通义

### 1.1 基本思想
- 一种使用**局部加权线性回归**进行数据平滑的方法
	- ![[Pasted image 20250307154605.png|400]]

- LOESS的基本思想：
	- 在每个数据点周围定义一个小的局部窗口（即邻域，带宽）
	- 对带宽内的数据点进行加权最小二乘回归，权重通常与该点到窗口中心的距离成反比
	- 重复这一过程，直到遍历所有数据点，从而生成一条平滑的曲线

### 1.2 数学原理

（1）**局部线性回归**模型：
- 非参数回归方法：不同点具有不同的参数
	- 适用于数据分布不均匀or关系随自变量变化的情况
- 局部线性回归模型表示为：
	$$y_i=\beta_0(x_i)+\beta_1(x_i)x_i+\epsilon_i$$
	- $\beta_0(x_i)$ 和 $\beta_1(x_i)$ 是在点 $x_i$ 处的回归系数，$\epsilon_i$ 是误差。
	- 局部回归中，$\beta_0(x_i)$ 和 $\beta_1(x_i)$ 是通过**最小化加权最小二乘法**得到的。

（2）**最小化加权最小二乘法**

- 假设我们有一个简单的线性模型 $y=\beta_0+\beta_1x$
- 在局部回归中，对于每个预测点 $x_i$，需要估计对应的$\beta_0(x_i)$ 和 $\beta_1(x_i)$。通过最小化以下目标函数实现：
	- 目标函数：模型预测值与实际观测值之间差异的某种度量
	- $$minimize_{\beta_0,\beta_1}\sum_{j=1}^{n}w_j(x_i)(y_j−(\beta_0+\beta_1xj))^2$$
		- $w_j(x_i)$：第 j个观测值相对于预测点$x_i$的权重，由**权重函数**计算得出
		- $y_j$：第 j 个观测的目标值。
		- $x_j$：第 j 个观测的特征值。

（3）**权重函数**&**带宽参数**
- 局部回归中，<u>不同数据点在拟合中的贡献（权重）不同</u>
- 权重 $w_i$
	- **权重函数**形式通常为$w_i=K(\frac{x-x_i}{h})$
		- K：**核函数**，如何根据数据点与预测点的**距离**来分配权重
			- 常用的核函数：高斯核（Gaussian kernel）、 Epanechnikov 核
			- 高斯核函数:
				- $$w_j​(x_i​)=exp(\frac{-(x_j​−x_i​)^2}{2h^2}​)$$
			-  三重权重函数（tricube weight function）：
				 - $$w(d)=(1−|d|^3)^3  for |d|<1$$
				- 其中 d是**标准化后的距离**（从当前点到窗口中心的距离除以窗口宽度）。

		- h：**带宽参数**，确定局部窗口的大小&影响权重随距离衰减的速度
			- 决定了每个局部窗口的大小，即局部回归的平滑程度
			- 较小的带宽会导致更局部化的拟合，而较大的带宽会导致更平滑的拟合
			- <u>平滑参数的选择对于 Loess 的性能影响显著</u>

### 1.3 算法原理

1. 定义带宽参数
	- 通常用分数表示，例如0.5表示数据集的一半

2. 确定权重函数
	- 为每个数据点分配权重。

3.  局部线性回归
	- 对于给定的数据点$(x_i,y_i)$，在每个点$x_i$处，通过对其邻域内的数据点进行局部线性回归，得到平滑后的$\widehat{y}_i$
		- 权重由带宽和权重函数确定
	- 在整个数据集上重复这个过程，连接所有数据点的拟合值，形成一条平滑的曲线。


## 2 Seasonal-Trend Decomposition Using LOESS（STL）

- [时间序列分解论文STL: A Seasonal-Trend Decomposition Procedure Based on Loess-CSDN博客](https://blog.csdn.net/qq_44384577/article/details/109222247) 推荐！
	- 源自相关文献《STL: A Seasonal-Trend Decomposiyion Procedure Based on Loess》
- **deepseek** 推荐！通义说的就是个p，瞎扯

### 2.1 算法概述

- STL（Seasonal-Trend decomposition using LOESS）是一种<strong>基于局部加权回归（LOESS）</strong>的时间序列分解方法。由Cleveland等人在1990年提出，主要用于从时间序列中提取出**趋势（Trend）、季节性（Seasonal）和残差成分**。
- STL分解将时间序列$Y_t$分解为以下三个主要部分
	- $$Y_t=T_t+S_t+R_t$$
		- $T_t$​：趋势成分，原始序列中减去季节性成分后得到残差序列，然后对该序列进行<u>平滑处理</u>以获得趋势成分
		- $S_t​$：季节性成分，周期性的分段，通过<u>平滑处理</u>得到初步的季节成分
		- $R_t​$：残差成分，原始序列减去趋势成分和季节性成分后的结果

---
- 原始序列：
	![[Pasted image 20250309214809.png]]
- 趋势项：数据中非平稳的长期变化的**低频变量**
	![[Pasted image 20250309214842.png]]
- 季节项：
	![[Pasted image 20250309214858.png]]
- 剩余项：
	![[Pasted image 20250309214912.png]]

### 2.2 算法步骤

- 方法包含两个主要的循环过程：**外循环**和**内循环**
	- 外循环包括一个完整的内循环过程和鲁棒性权重的计算
	- <span style="color:red;"><strong>鲁棒性权重</strong></span>
		- 在下一次内循环中用于减少<u>暂时的、离奇的点</u>对趋势项和季节项的影响

- **关键点**：
	- 内循环：通过交替平滑季节和趋势成分，逐步优化分解结果。
	- 低通滤波：分离季节中的高频部分和低频部分，确保趋势捕获长期变化。 
	- 鲁棒性：外循环通过权重调整降低异常值影响，提升分解稳定性。

---

1. 参数设置

	- 季节周期长度（如12个月）
	- 内循环次数（通常3-5次）
	- 外循环次数（通常1-5次）
	- LOESS平滑的跨度参数（季节和趋势的平滑窗口）

2. **外循环（鲁棒性迭代）**
	- **目的**：根据残差计算鲁棒权重，用于下一轮内循环中的LOESS平滑过程
	- 初始化：首次外循环时，<u>鲁棒权重全为1</u>；后续外循环根据残差调整权重。
	- 每次外循环执行以下步骤：

		a. **内循环（分解迭代）**：
		
		- 初始化：若为首次迭代，趋势成分 $T$ 初始化为0 or 通过<u>移动平均</u>估计
		- 重复内循环指定次数：重复以下步骤，直到完成$n_{inner}$次迭代
			1. 去趋势：  
				- 根据当前趋势估计$T_v^{k-1}$，计算当前去趋势数据：$detrended=Y_v−T_v^{k-1}$
				- $k$：当前的内循环次数，最好用$k+1$代替原来的$k$次
			2. **周期子序列平滑 （Seasonal Smoothing）**
				- 将$detrended$数据按季节周期分成$n_p$个子序列，$n_p$等于<span style="color:red;"><strong>周期长度</strong></span>
					- 例如，月度数据（周期$n_p$=12）中，所有年1月的数据构成一个子序列，2月的数据构成另一个子序列，以此类推。
						- 月度数据：每年每个月只有一个值。
				- <span style="color:red;">对每个季节性子序列分别应用LOESS平滑</span>
					-  LOESS平滑中，领域权重需<span style="color:red;">乘以鲁棒权重</span>$w_v$
						- <u>邻近权重</u>：LOESS本身根据时间邻近性赋予的权重（如距离越近的点权重越高）
						- 平滑操作会向前后各扩展一个周期，以确保序列的起点和终点附近的平滑值也能通过足够的数据点计算，避免边界效应
							- 若原始序列从1943年1月到1985年1月，则扩展后覆盖1942年1月至1986年1月，即时间长度为$v=-n_p+1$到$N+n_p$。$N$。
				- 每个周期子序列的平滑结果按时间顺序<span style="color:red;"><strong>拼接</strong></span>成$C_v^k$
					- <span style="color:red;"><strong>与原始时序长度相同！</strong></span>
					- 如：1943年的1月经过1月子序列的LOESS平滑平均估计得到，然后和1943年的2月，...,1985年12月，<u>一个个平滑平均值按时间拼接成和原序列长度相同的时序</u>
			3. <span style="color:red;"><strong>低通滤波</strong></span>
				- 季节成分捕获重复的高频变化，而**趋势捕获低频变化**
					- 去除$C_v^k$中的趋势成分的影响
				- 应用于$C_v^k$，进行低通滤波
					- 应用长度为季节周期的移动平均，得到MA1。
					- 对MA1应用长度为3的移动平均，得到MA2。
					- 对MA2应用LOESS平滑，跨度较大（如用户设定），得到$L_v^k$
				- 计算调整后的<mark class="highlight">季节成分</mark>：$S_v^k = C_v^k - L_v^k$
			4. 去季节化
				- 计算去季节数据：$deseasoned = Y_v - S_v^k$
			5. **趋势平滑 （Trend Smoothing）**
				- 对$deseasoned$数据应用**LOESS平滑**，得到新的<mark class="highlight">趋势估计</mark>$T_v^k$
					- LOESS平滑中，领域权重需<span style="color:red;">乘以鲁棒权重</span>$w_v$
			6. 更新成分：$T_v$←$T_v^k$，$S_v$←$S_v^k$

		b. **更新鲁棒性权重**：
		
		1. 计算残差：$R = Y - T_v - S_v$
		2. 计算鲁棒权重
			1. 计算绝对偏差中位数：$m = median(|R|)$
			2. 计算鲁棒权重$w_i = B(\frac{|R_i| }{(6m)})$
				- $B$是双平方函数，当$u >=1$时$B(u)=0$，否则$B(u)=(1 - u^2)^2$
				- $R_i​$：第 $i$个时间点的残差
				- $w_i$：第 $i$个时间点的鲁棒权重
3. 输出结果
	- 趋势成分 $T_v$
	- 季节成分 $S_v$：<span style="color:red;"><strong>与原始时序长度相同！</strong></span>
	- 残差成分 $R$









